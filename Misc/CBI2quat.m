function q = CBI2quat(DCM)
    A = DCM;
    q = zeros(4,1); % [q1; q2; q3; q4] â€” vector-first

    tr = trace(A);

    if tr > 0
        S = sqrt(tr + 1.0) * 2; % S = 4*q4
        q(4) = 0.25 * S;
        q(1) = (A(3,2) - A(2,3)) / S;
        q(2) = (A(1,3) - A(3,1)) / S;
        q(3) = (A(2,1) - A(1,2)) / S;
    elseif (A(1,1) > A(2,2)) && (A(1,1) > A(3,3))
        S = sqrt(1.0 + A(1,1) - A(2,2) - A(3,3)) * 2; % S = 4*q1
        q(1) = 0.25 * S;
        q(2) = (A(1,2) + A(2,1)) / S;
        q(3) = (A(1,3) + A(3,1)) / S;
        q(4) = (A(3,2) - A(2,3)) / S;
    elseif (A(2,2) > A(3,3))
        S = sqrt(1.0 + A(2,2) - A(1,1) - A(3,3)) * 2; % S = 4*q2
        q(1) = (A(1,2) + A(2,1)) / S;
        q(2) = 0.25 * S;
        q(3) = (A(2,3) + A(3,2)) / S;
        q(4) = (A(1,3) - A(3,1)) / S;
    else
        S = sqrt(1.0 + A(3,3) - A(1,1) - A(2,2)) * 2; % S = 4*q3
        q(1) = (A(1,3) + A(3,1)) / S;
        q(2) = (A(2,3) + A(3,2)) / S;
        q(3) = 0.25 * S;
        q(4) = (A(2,1) - A(1,2)) / S;
    end

    q = q / norm(q); % normalize
end